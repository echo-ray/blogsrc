---
title: Linuxio介绍
date: 2018-08-27 12:12:28
tags:
- Linux
---

## io基础铺垫

### 一些概念

#### 同步和异步

从消息通知机制的角度看。

假设你到移动营业厅去办理业务：

同步就是**排队**，如果你前面的人没有完成，在此期间，你要一直排队不可以离开队伍干其他的事情。

异步就是**叫号**，你到了领取一个号，等待被叫，在此期间你可以去外边吃点凉皮啥的。

<!--more-->
#### 阻塞与非阻塞

从程序等待消息通知时的状态的角度。

接着上面的场景，无论你是排队(**同步**)还是叫号(**异步**)：

如果你在此期间除了等轮到自己办理业务你啥也没有干，那么就是**阻塞**的。

如果你在此期间除了等轮到自己办理业务你还在和别人打电话，那么就是**非阻塞**的。

#### 同步/异步阻塞/非阻塞

场景：小明下载一个文件

##### 同步阻塞

效率是最低

小明一直盯着下载进度条，直到 100% 的时候就完成。

##### 同步非阻塞

小明提交下载任务后就去干别的，每过一段时间就去瞄一眼进度条，看到 100% 就完成。

##### 异步阻塞

效率低下

小明换了个有下载完成通知功能的软件，下载完成就“叮”一声。不过小明仍然一直等待“叮”的声音

##### 异步非阻塞

效率更高

仍然是那个会“叮”一声的下载软件，小明提交下载任务后就去干别的，听到“叮”的一声就知道完成了

**同步/异步是“下载完成消息”通知的方式（机制），而阻塞/非阻塞则是在等待“下载完成消息”通知过程中的状态（能不能干其他任务）**

#### 用户空间与内核空间

操作系统的核心是内核，内核是应用程序，可以访问受保护的内存空间，也可具有访问底层硬件设备的权限。so 内核很重要，要有一定的安全机制，用户进程是不可以随便访问的。

为了防止用户进程随便访问内核，现代操作系统将虚拟空间分为两个，内核空间和用户空间。对于32位的Linux操作系统来说，较高的1G内存空间为内核准备是内核空间，剩下的3G为用户准备是用户空间。


#### 进程切换

有上面知道，用户进程想要去访问硬件需要内核才可以进行。这样的话内核就要对不同的进程进行管理，内核必须有能力挂起正在CPU上运行的进程，并恢复以前挂起的某个进程的执行。这种行为被称为**进程切换**。

#### 进程阻塞

由于某些原因，进程需要等待资源，此时内核将运行状态中的进程挂起，使之成为阻塞状态，以便腾出cpu资源。阻塞状态的进程是不占用cpu的。

#### 文件描述符

进程对文件的操作时，内核会向进程返回一个文件描述符。文件描述符实际上是内核为进程维护的该进程所打开的文件记录表，是个索引。

#### 缓存 IO

程序操作数据，内核会首先将数据放到页面缓存(page cache)中也就是内核的缓冲区，然后再从操作系统内核的缓冲区拷贝到应用程序的地址空间。

#### 两阶段

用户空间io操作两个阶段：

等待数据准备就绪

将数据从内核拷贝到进程中

### Linux中I/O模型

简图

![figure1](https://qiniu.li-rui.top/figure1.gif)

调用blocking IO会一直block住对应的进程直到操作完成，而non-blocking IO在kernel还准备数据的情况下会立刻返回。

blocking IO，non-blocking IO，IO multiplexing都属于synchronous IO。

而asynchronous IO则不一样，当进程发起IO 操作之后，就直接返回再也不理睬了，直到kernel发送一个信号，告诉进程说IO完成。在这整个过程中，进程完全没有被block。

五种io区别
![21095604_vhHX](https://qiniu.li-rui.top/21095604_vhHX.png)