---
title: 浅谈sql高可用
date: 2018-07-30 17:12:28
tags:
- 浅谈
---

## 实施需求
实施一套立体式高可用解决方案，从web到数据库，再到数据库存储。web和数据库操作系统环境为Windows server 2012 R2，数据库为SQL2012。

![高可用架构](https://qiniu.li-rui.top/高可用架构.jpg)

<!--more-->

## 理解高可用
首先，如何理解故障？其次，如何理解故障转移？最后，如何理解高可用？
假设女朋友晚上喜欢切水果给男朋友吃。这叫服务。
你有一个女朋友，但是你们吵架了，晚上她不想给你切水果。这叫服务故障。
你有一个女朋友，但是你们分手了，晚上她不能给你切水果。这叫主机故障。
你有一个女朋友，但是你们吵架了，可你偏偏晚上要吃女朋友切的水果，于是你又找了一个女朋友，你和她没有吵架，于是可以吃女朋友切的水果了。这叫故障转移。
现在呢，你有两个女朋友（资源冗余），只要你和其中一个女朋友吵架，晚上你就到另外一个女朋友那里吃她切的水果（服务切换无感知和数据实时一致性），这叫高可用。
综上，高可用的核心是资源冗余，关键是服务切换无感知和数据实时一致性。

## 数据库
SQL Server 中的高可用性解决方案常用的有三种：一种是数据库镜像，另一种是故障转移集群数据库实例，最后一种是AlwaysON。

### 数据库镜像
数据库镜像要两台数据库服务器和至少一台域控再加一台数据库见证机，其中一台服务器为主机，另一台为镜像机。域控提供账户认证服务，见证机提供主机和镜像机切换服务。web连接的主机的IP。数据库镜像主要解决服务故障，一台数据库服务出问题了另一台还可以继续提供服务。前提是出问题的那台服务器不可以关机，因为web对接的IP还在上面。
数据库镜像如何实现高可用中的两个关键呢？对于“服务切换无感知”，SQL使用内部指针来完成，指针所指向的服务器就是主机，服务故障检测和指针指向切换由见证机来完成。可见，见证机也可以不要，手动切换也可以。对于“数据实时一致性”，SQL自身来实现。

### 故障转移集群数据库实例

故障转移集群数据库实例要至少两台数据服务器和至少一台域控再加至少一台数据库共享存储来提供iSCSI服务，集群会向外发布一个浮动IP，这个IP会在两台服务器之间漂移，也是web接入的IP。它主要解决主机故障，一台服务器关机了另一台还可以继续提供服务。
故障转移集群数据库实例又是如何实现高可用的两个关键呢？对于“服务切换无感知”，SQL数据库实例是建立在WSFC（Windows Server Failover Clustering）windows 服务故障转移集群基础上的，WSFC来完成服务切换。对于“数据实时一致性”，SQL数据库实例分别依靠DTC（Distributed Transaction Coordinator）分布式事务协调器在数据库操作层面保证数据库事务一致性和数据库共享存储在数据库数据存储层面保证数据一致性。


### 域控
不管是数据库镜像还是故障转移集群数据库实例都需要在Windows域中进行身份认证，可见域控的重要性。Windows本身支持域控的高可用，即建立辅助域控。

Windows server 2016 +SQL server 2016可以不需要域控。

## 数据库存储
### 数据同步

高可用的两个关键中，相对于“服务器切换无感知”，存储更关心“数据实时一致性”。实现原理也很简单，写入一个地方的数据实时同步到另一个地方。但是如何保证实时，怎样同步？实时保证需要Linux内核级别的支持，同步概括来说分两类：文件级别和block（文件都是分成许许多多的block存储的）级别。文件级别常用工具有lsyncd（Live Syncing Daemon）和FreeFileSync等等比较多。
block级别常用的工具有DRBD（Distributed Replicated Block Device）和ceph。如果DRBD是水果刀（女朋友用的那种）那么ceph就是瑞士军刀。
block级别同步相对于文件级别有两个优势：更底层，是和文件系统格式没有关系的，随便你用xfs以及ext4的分区格式都无所谓；同步过程不需要额外的文件描述符（程序与文件的交流是通过文件描述符进行的，文件描述符是需要内存空间的，Windows里面叫文件句柄）。


### 服务切换

“服务器切换无感知”在存储集群中如何实现呢？服务切换伴随的是集群内资源的转移，资源的转移实际上是集群内特定服务在不同集群节点上的启动和关闭。keepalived是一个选择，但它主要管理IP资源的转移，而且配合DRBD用着缺乏美感。pacemaker是更好的选择，相对keepalived pacemaker可以管理更多的资源类型，重要的是pacemaker自带心跳插件corosync。对于资源管理pacemaker可以提供非常多的资源编排方式，如资源之间绑定、资源启动关闭次序等。


## 宿主机
如果web、数据库、域控、数据库存储都是两台基于kvm的服务器，如何做宿主机方面的高可用呢？
把他们放在两台宿主机上，一台宿主机放一套web、数据库、域控、数据库存储。


