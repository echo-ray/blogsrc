---
title: 浅谈服务注册和发现
date: 2019-03-27 12:12:28
tags:
- 浅谈
---

![下载](https://qiniu.li-rui.top/下载.png)

<!--more-->

# 分布式系统的CAP

分布式系统是业务规模逐渐扩大之后必须要上的方案，相对于单机系统，分布式系统在提供服务的时候存在cap理论。

- Consistency
- Availability
- Partition tolerance

对于单机系统，数据是放在一个地方的，系统内数据不变的情况下，外部请求的时候数据总是一致的。单机系统不挂的话，外部请求也总是可用的。因为是单机系统也不会出现服务之间的通讯中断

但是对于分布式系统就不一样了，数据不会只存在一个节点上，有些还不止一份存放。当有新的数据增加进来或者旧的数据删除时，外部调用的时候就要去保证整个分布式系统中节点提供数据的一致性，以及整个服务的可用性。

## partition tolerance

分区容错，就是说在分布式系统中节点之间可能会因为网络问题导致通讯中断，从实际来看系统中的网络中断总是无法避免的。比如一个分布式系统中服务端存在两个节点，当一个节点新增一个数据后就会向另外一个节点同步数据。但是另一个节点有可能收不到这个同步数据的请求。这就造成了数据的分区。分区容错就是，在一个分布式系统中一些节点挂了还可以提供服务。

## Consistency

一致性，主要是指分布式系统中的各个节点数据对外提供数据的一致性。一致性有多种类型：
- 强一致性 数据更新后访问者都可访问到最新数据 
- 弱一致性 数据更新后部分访问者访问不到最新数据，或者全部访问不到。弱一致性包含顺序一致性和线性一致性
  - 顺序一致性 写的顺序决定了其他人看到的顺序 paxos
  - 线性一致性 协和读顺序是和时间相关的
- 最终一致性 数据更新一段时间后访问者都可以访问到，可以理解为弱一致性的最终结果 paxos为最终一致性算法

而对于每一种一致性还分为两种，读和写的强弱一致性

## Availability

可用性，主要是指分布系统被外部调用的时候总是有响应

## 相关关系

分布式系统基础就是一台系统中一个节点挂了，依靠其他节点分布式系统仍然可以对外提供服务(请注意此时服务是启动的，也是可以提供数据的)，那么问题的关键是在保证分布式系统没有全部挂掉的情况下来讨论服务提供数据的可用性和一致性问题。也就是说可用性和一致性需要有侧重的方面。

假设现在有一个分布式系统，里面有3个节点。1节点挂掉了，2节点收到了一个新的数据。此时客户端访问3节点机会出现可用性和一致性就那个的问题

- 侧重一致性，在数据没有同步到3节点之前，整个分布式系统不会提供服务，也就是说没有可用性。比如数据库系统
- 侧重可用性，在数据没有同步到3节点之前，分布式系统可以提供一些没有更新的数据，也就是说放弃一致性，首先保证可用性。接着可以在未来的某个时间点上同步完成新的数据，来达到最终一致性。比如DNS系统

# 分布式中的服务治理

## 服务代理

服务是可以提供资源的，比如一个http服务、一个邮件服务，有了提供资源就有使用资源的。于是就有服务提供者和服务消费者。互联网早期的时候，服务消费者比较少，对应的服务提供者也比较少。大家都比较单纯，我想要什么服务就直接去找服务提供者了。

但是，后期随着业务逐渐庞大，同一类型的服务提供者需要多个才可以满足需要，这么多个服务提供者不都是一直稳定的，总有些老幼病残不能提供服务。那么对于服务消费者就会面临一些问题：
- 这么多服务提供者，作为消费的他们如何实时找到服务提供者
- 服务提供者出现了老弱病残，消费者如何能及时或者在允许的时间内发现并提出他们

这就需要第三方出现了--服务代理。服务代理可以帮助服务消费者管理服务提供者，保证向服务消费者提供的服务提供者列表中的条目总是可用的。这样服务消费者只需要跟服务代理通讯就行了。

但是问题又来了，如果服务代理挂了呢？答案也很简单，就是分布式部署服务代理！

服务代理的基础就是分布式键值存储系统，在此基础上再去实现服务注册和发现的功能。对于分布式键值存储系统中有两种常见的一致性算法：paxos和raft。其中raft协议相对简单些。基于这两种协议的实现，出现了一些一致性工具：consul和etcd基于raft，zookeeper基于paxos。

# raft日志复制机制

- 客户端向leader发送新值，leader会首先将数值写入到log中
- leader将log向所有follower进行推送
- 当大多数的follower已经把log写入到他们的log存储中会给leader反馈
- leader收到大多数follower写入log反馈后，会将写入log中的数值写入到他的状态中
- leader状态更改后会通知follower整个系统状态已经更新

更多参考[raft一致性算法动画](http://thesecretlivesofdata.com/raft/)


